<?php



namespace app\controllers;

use Yii;
use yii\rest\Controller;
use app\models\TableOrder;
use app\models\Product;
use app\models\Promo;

class OrderController extends Controller
{

    public function behaviors()
    {
        $behaviors = parent::behaviors();
        $behaviors['contentNegotiator']['formats']['application/json'] = \yii\web\Response::FORMAT_JSON;
        return $behaviors;
    }

    
    public function actionPostOrder()
    {
        $request = Yii::$app->request->post();
       
        $orders = $request['orders'];
    
        $tableNo = $request['table_no'];

        foreach ($orders as $order) {
            $tableOrder = new TableOrder();
            $tableOrder->table_no = $tableNo;
            $tableOrder->product_id = $order['product_id'];
            $tableOrder->quantity = $order['quantity'];
            $tableOrder->save();
        }

        return [
            'message' => 'Order placed successfully',
            'printer' => $this->getPrinterStations($orders),
        ];
    }

    private function getPrinterStations($orders)
    {
        $stations = [];
        foreach ($orders as $order) {
            $product = Product::findOne($order['product_id']);
            if ($product->category == 'makanan') {
                $stations[] = 'Printer Dapur (Makanan)';
            } elseif ($product->category == 'minuman') {
                $stations[] = 'Printer Bar (Minuman)';
            }
        }
        return array_unique($stations);
    }

    public function actionGetBill()
    {
        
        $tableNo = Yii::$app->request->get('table_no');
        $orders = TableOrder::find()->where(['table_no' => $tableNo])->all();
        $total = 0;

        foreach ($orders as $order) {
            $product = Product::findOne($order->product_id);
            $total += $product->price * $order->quantity;
        }

        return [
            'table_no' => $tableNo,
            'total' => $total,
            'orders' => $orders,
        ];
    }
}
